From c9597564edfab32cad9f9db44b0a7b5a4a6e00e1 Mon Sep 17 00:00:00 2001
From: Vadim Pasternak <vadimp@mellanox.com>
Date: Mon, 1 Aug 2016 06:46:00 +0000
Subject: [patch] aspeed evb workaround

Signed-off-by: Vadim Pasternak <vadimp@mellanox.com>
---
 linux/Makefile                                | 8 +++-----
 linux/arch/arm/boot/compressed/atags_to_fdt.c | 2 +-
 linux/arch/arm/include/asm/futex.h            | 3 +++
 3 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/linux/Makefile b/linux/Makefile
index cd37442..c483202 100644
--- a/linux/Makefile
+++ b/linux/Makefile
@@ -557,7 +557,6 @@ drivers-y	:= drivers/ sound/ firmware/
 net-y		:= net/
 libs-y		:= lib/
 core-y		:= usr/
-virt-y		:= virt/
 endif # KBUILD_EXTMOD
 
 ifeq ($(dot-config),1)
@@ -903,10 +902,10 @@ core-y		+= kernel/ certs/ mm/ fs/ ipc/ security/ crypto/ block/
 
 vmlinux-dirs	:= $(patsubst %/,%,$(filter %/, $(init-y) $(init-m) \
 		     $(core-y) $(core-m) $(drivers-y) $(drivers-m) \
-		     $(net-y) $(net-m) $(libs-y) $(libs-m) $(virt-y)))
+		     $(net-y) $(net-m) $(libs-y) $(libs-m)))
 
 vmlinux-alldirs	:= $(sort $(vmlinux-dirs) $(patsubst %/,%,$(filter %/, \
-		     $(init-) $(core-) $(drivers-) $(net-) $(libs-) $(virt-))))
+		     $(init-) $(core-) $(drivers-) $(net-) $(libs-))))
 
 init-y		:= $(patsubst %/, %/built-in.o, $(init-y))
 core-y		:= $(patsubst %/, %/built-in.o, $(core-y))
@@ -915,11 +914,10 @@ net-y		:= $(patsubst %/, %/built-in.o, $(net-y))
 libs-y1		:= $(patsubst %/, %/lib.a, $(libs-y))
 libs-y2		:= $(patsubst %/, %/built-in.o, $(libs-y))
 libs-y		:= $(libs-y1) $(libs-y2)
-virt-y		:= $(patsubst %/, %/built-in.o, $(virt-y))
 
 # Externally visible symbols (used by link-vmlinux.sh)
 export KBUILD_VMLINUX_INIT := $(head-y) $(init-y)
-export KBUILD_VMLINUX_MAIN := $(core-y) $(libs-y) $(drivers-y) $(net-y) $(virt-y)
+export KBUILD_VMLINUX_MAIN := $(core-y) $(libs-y) $(drivers-y) $(net-y)
 export KBUILD_LDS          := arch/$(SRCARCH)/kernel/vmlinux.lds
 export LDFLAGS_vmlinux
 # used by scripts/pacmage/Makefile
diff --git a/linux/arch/arm/boot/compressed/atags_to_fdt.c b/linux/arch/arm/boot/compressed/atags_to_fdt.c
index 9448aa0..b66f4dd 100644
--- a/linux/arch/arm/boot/compressed/atags_to_fdt.c
+++ b/linux/arch/arm/boot/compressed/atags_to_fdt.c
@@ -112,7 +112,7 @@ int atags_to_fdt(void *atag_list, void *fdt, int total_space)
 	 * address and size for each bank */
 	uint32_t mem_reg_property[2 * 2 * NR_BANKS];
 	int memcount = 0;
-	int ret, memsize;
+	int ret, memsize = 0;
 
 	/* make sure we've got an aligned pointer */
 	if ((u32)atag_list & 0x3)
diff --git a/linux/arch/arm/include/asm/futex.h b/linux/arch/arm/include/asm/futex.h
index 6795368..adc17ed 100644
--- a/linux/arch/arm/include/asm/futex.h
+++ b/linux/arch/arm/include/asm/futex.h
@@ -108,6 +108,7 @@ futex_atomic_cmpxchg_inatomic(u32 *uval, u32 __user *uaddr,
 
 	preempt_disable();
 	__ua_flags = uaccess_save_and_enable();
+/*
 	__asm__ __volatile__("@futex_atomic_cmpxchg_inatomic\n"
 	"1:	" TUSER(ldr) "	%1, [%4]\n"
 	"	teq	%1, %2\n"
@@ -117,6 +118,8 @@ futex_atomic_cmpxchg_inatomic(u32 *uval, u32 __user *uaddr,
 	: "+r" (ret), "=&r" (val)
 	: "r" (oldval), "r" (newval), "r" (uaddr), "Ir" (-EFAULT)
 	: "cc", "memory");
+*/
+	val = 0;
 	uaccess_restore(__ua_flags);
 
 	*uval = val;
-- 
2.1.4

